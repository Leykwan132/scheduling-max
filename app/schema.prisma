datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  email    String? @unique
  username String? @unique
  isAdmin  Boolean @default(false)

  paymentProcessorUserId        String?   @unique
  lemonSqueezyCustomerPortalUrl String? // You can delete this if you're not using Lemon Squeezy as your payments processor.
  subscriptionStatus            String? // 'active', 'cancel_at_period_end', 'past_due', 'deleted'
  subscriptionPlan              String? // 'hobby', 'pro'
  datePaid                      DateTime?
  credits                       Int       @default(3)

  // User Profile Fields
  profileImageFileId String? @unique
  profileImageFile   File?   @relation("ProfileImage", fields: [profileImageFileId], references: [id])
  slug               String? @unique
  bio                String?
  position           String? // e.g., "Senior Barber"

  // Operation Hours
  openingTime String? // e.g., "09:00"
  closingTime String? // e.g., "17:00"
  workDays    String? // Comma-separated days: "mon,tue,wed,thu,fri"

  contactFormMessages ContactFormMessage[]
  files               File[]               @relation("UserFiles")

  // Relations
  businessId String?
  business   Business? @relation(fields: [businessId], references: [id])

  isBusinessOwner Boolean @default(false)

  // Social & Public Contact
  igUrl       String?
  tiktokUrl   String?
  facebookUrl String?
  websiteUrl  String?
  publicEmail String?
  publicPhone String?

  customers Customer[]
  services  Service[]
  bookings  Booking[]  @relation("StaffBookings")
}

model File {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  user   User   @relation("UserFiles", fields: [userId], references: [id])
  userId String

  name  String
  type  String
  s3Key String

  // Back-reference for profile image
  profileImageUser User? @relation("ProfileImage")
}

model DailyStats {
  id   Int      @id @default(autoincrement())
  date DateTime @unique @default(now())

  totalViews                Int    @default(0)
  prevDayViewsChangePercent String @default("0")
  userCount                 Int    @default(0)
  paidUserCount             Int    @default(0)
  userDelta                 Int    @default(0)
  paidUserDelta             Int    @default(0)
  totalRevenue              Float  @default(0)
  totalProfit               Float  @default(0)

  sources PageViewSource[]
}

model PageViewSource {
  name String
  date DateTime @default(now())

  dailyStats   DailyStats? @relation(fields: [dailyStatsId], references: [id])
  dailyStatsId Int?

  visitors Int

  @@id([date, name])
}

model Logs {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())

  message String
  level   String
}

model ContactFormMessage {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  user   User   @relation(fields: [userId], references: [id])
  userId String

  content   String
  isRead    Boolean   @default(false)
  repliedAt DateTime?
}

model Business {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users User[]

  name     String
  slug     String  @unique
  imageUrl String?
  logoUrl  String?
  phone    String?

  services  Service[]
  customers Customer[]
  bookings  Booking[]
}

model Service {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  businessId String
  userId     String?
  user       User?    @relation(fields: [userId], references: [id])

  name        String
  description String?
  duration    Int // in minutes
  price       Float
  isActive    Boolean @default(true)

  bookings Booking[]
}

model Customer {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  businessId String

  user   User?   @relation(fields: [userId], references: [id])
  userId String?

  name  String
  phone String
  email String?
  notes String?

  bookings Booking[]
}

model Booking {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  businessId String

  customer   Customer @relation(fields: [customerId], references: [id])
  customerId String

  service   Service @relation(fields: [serviceId], references: [id])
  serviceId String

  staff   User   @relation("StaffBookings", fields: [staffId], references: [id])
  staffId String

  date      DateTime
  startTime String // "09:00" format
  duration  Int // in minutes
  status    String   @default("confirmed") // confirmed, pending, cancelled
  notes     String?
  price     Float
}
