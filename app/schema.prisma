datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  email    String? @unique
  username String? @unique
  isAdmin  Boolean @default(false)

  paymentProcessorUserId        String?   @unique
  lemonSqueezyCustomerPortalUrl String? // You can delete this if you're not using Lemon Squeezy as your payments processor.
  subscriptionStatus            String? // 'active', 'cancel_at_period_end', 'past_due', 'deleted'
  subscriptionPlan              String? // 'hobby', 'pro'
  datePaid                      DateTime?
  credits                       Int       @default(3)

  // User Profile Fields
  profileImageFileId String? @unique
  profileImageFile   File?   @relation("ProfileImage", fields: [profileImageFileId], references: [id])
  slug               String? @unique
  bio                String?
  position           String? // e.g., "Senior Barber"

  // Operation Hours
  openingTime  String? // e.g., "09:00"
  closingTime  String? // e.g., "17:00"
  workDays     String? // Comma-separated days: "mon,tue,wed,thu,fri"
  timezone     String? @default("UTC")
  location     String? // Business/service location address or "Remote"
  bufferBefore Int?    @default(0) // Buffer time in minutes before appointments
  bufferAfter  Int?    @default(0) // Buffer time in minutes after appointments

  // Maximum Appointments Settings
  maxAppointmentsMode   String? @default("fully_booked") // "fully_booked" or "max_per_day"
  maxAppointmentsPerDay Int?    @default(0) // 0 means unlimited, only used when mode is "max_per_day"

  contactFormMessages ContactFormMessage[]
  files               File[]               @relation("UserFiles")

  // Relations
  businessId String?
  business   Business? @relation(fields: [businessId], references: [id])

  isBusinessOwner Boolean @default(false)

  // Social & Public Contact
  igUrl       String?
  tiktokUrl   String?
  facebookUrl String?
  websiteUrl  String?
  publicEmail String?
  publicPhone String?

  customers   Customer[]
  services    Service[]
  bookings    Booking[]    @relation("StaffBookings")
  schedules   Schedule[]
  reviews     Review[]     @relation("StaffReviews")
  intakeForms IntakeForm[] // Custom intake forms created by user

  googRefreshToken String?

  // Page Style Customization (JSON)
  styleConfig String? // JSON: template, background, button, font, profile settings

  // Onboarding
  onboardingCompleted Boolean @default(false)
}

model File {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  user   User   @relation("UserFiles", fields: [userId], references: [id])
  userId String

  name  String
  type  String
  s3Key String

  // Back-reference for profile image
  profileImageUser User? @relation("ProfileImage")
}

model DailyStats {
  id   Int      @id @default(autoincrement())
  date DateTime @unique @default(now())

  totalViews                Int    @default(0)
  prevDayViewsChangePercent String @default("0")
  userCount                 Int    @default(0)
  paidUserCount             Int    @default(0)
  userDelta                 Int    @default(0)
  paidUserDelta             Int    @default(0)
  totalRevenue              Float  @default(0)
  totalProfit               Float  @default(0)

  sources PageViewSource[]
}

model PageViewSource {
  name String
  date DateTime @default(now())

  dailyStats   DailyStats? @relation(fields: [dailyStatsId], references: [id])
  dailyStatsId Int?

  visitors Int

  @@id([date, name])
}

model Logs {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())

  message String
  level   String
}

model ContactFormMessage {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  user   User   @relation(fields: [userId], references: [id])
  userId String

  content   String
  isRead    Boolean   @default(false)
  repliedAt DateTime?
}

model Business {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users User[]

  name     String
  slug     String  @unique
  imageUrl String?
  logoUrl  String?
  phone    String?

  services   Service[]
  customers  Customer[]
  bookings   Booking[]
  promos     Promo[]
  reviews    Review[]
  categories ServiceCategory[]

  // Socials & Contact
  instagramUrl          String?
  isInstagramEnabled    Boolean @default(true)
  tiktokUrl             String?
  isTikTokEnabled       Boolean @default(true)
  facebookUrl           String?
  isFacebookEnabled     Boolean @default(true)
  websiteUrl            String?
  isWebsiteEnabled      Boolean @default(true)
  contactEmail          String?
  isContactEmailEnabled Boolean @default(true)
  isPhoneEnabled        Boolean @default(true)

  // Integrations
  isGoogleCalendarConnected Boolean               @default(false)
  isStripeConnected         Boolean               @default(false)
  stripeConnectAccount      StripeConnectAccount?
}

model StripeConnectAccount {
  id        String   @id // Stripe account ID (acct_xxx)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relation to Business
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  businessId String   @unique

  // Account details
  displayName     String?
  country         String  @default("us")
  defaultCurrency String  @default("usd")
  dashboardAccess String  @default("full")

  // Onboarding status: not_started, in_progress, pending_review, complete, rejected, requirements_due
  onboardingStatus String  @default("not_started")
  disabledReason   String?

  // Requirements
  requirementsStatus  String? // currently_met, currently_due, past_due
  pendingRequirements String? // JSON string

  // Capabilities
  cardPaymentsEnabled Boolean @default(false)
  transfersEnabled    Boolean @default(false)

  // Metadata
  lastWebhookAt DateTime?
}

model Service {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  businessId String
  userId     String?
  user       User?    @relation(fields: [userId], references: [id])

  name        String
  description String?
  duration    Int // in minutes
  price       Float
  location    String? // Service location - can be user's default location or custom
  isActive    Boolean @default(true)

  categoryId String?
  category   ServiceCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  bookings Booking[]
}

model ServiceCategory {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  businessId String

  name String

  services Service[]
  forms    IntakeForm[] @relation("FormCategories") // Linked intake forms

  @@unique([businessId, name])
}

model Customer {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  businessId String

  user   User?   @relation(fields: [userId], references: [id])
  userId String?

  name  String
  phone String
  email String?
  notes String?

  bookings Booking[]
}

model Booking {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  businessId String

  customer   Customer @relation(fields: [customerId], references: [id])
  customerId String

  service   Service @relation(fields: [serviceId], references: [id])
  serviceId String

  staff   User   @relation("StaffBookings", fields: [staffId], references: [id])
  staffId String

  date         DateTime
  startTimeUtc DateTime // Full UTC timestamp for the booking start
  endTimeUtc   DateTime // Full UTC timestamp for the booking end
  status       String   @default("confirmed") // confirmed, pending, cancelled
  notes        String?
  price        Float

  googleCalendarEventId String? // ID of the synced Google Calendar event

  reminderPreference String  @default("email") // "sms", "email", or "both"
  reminderSent       Boolean @default(false) // Track if 1-hour reminder was sent

  review       Review?
  formResponse FormResponse? // Intake form response if applicable
}

model Schedule {
  id        String             @id @default(uuid())
  user      User               @relation(fields: [userId], references: [id])
  userId    String
  name      String             @default("Default Schedule")
  days      ScheduleDay[]
  overrides ScheduleOverride[]
}

model ScheduleDay {
  id         String   @id @default(uuid())
  schedule   Schedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  scheduleId String
  dayOfWeek  String // "monday", "tuesday", etc.
  startTime  String // "09:00"
  endTime    String // "17:00"
}

model ScheduleOverride {
  id            String   @id @default(uuid())
  schedule      Schedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  scheduleId    String
  date          String // "YYYY-MM-DD"
  isUnavailable Boolean  @default(false)
  startTime     String?
  endTime       String?
}

model Promo {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  businessId String
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  code     String
  isActive Boolean @default(true)

  type  String // "percent" or "fixed"
  value Float
}

model Review {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  rating  Int // 1 to 5
  title   String?
  content String?

  businessId String
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  bookingId String  @unique // One review per booking
  booking   Booking @relation(fields: [bookingId], references: [id])

  userId String?
  user   User?   @relation("StaffReviews", fields: [userId], references: [id]) // Staff member being reviewed
}

// ============================================
// Intake Forms - Custom questionnaires
// ============================================

model IntakeForm {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  name        String?
  description String?
  isInternal  Boolean @default(false) // If true, don't show to clients

  questions  FormQuestion[]
  categories ServiceCategory[] @relation("FormCategories")
  responses  FormResponse[]
}

model FormQuestion {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  form   IntakeForm @relation(fields: [formId], references: [id], onDelete: Cascade)
  formId String

  type       String // "text", "checkbox", "checkbox_list", "yes_no", "dropdown"
  label      String
  options    String? // JSON array for checkbox_list/dropdown options
  isRequired Boolean @default(false)
  order      Int     @default(0)
}

model FormResponse {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  form      IntakeForm @relation(fields: [formId], references: [id], onDelete: Cascade)
  formId    String
  booking   Booking    @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  bookingId String     @unique

  answers String // JSON object: { questionId: answer }
}
